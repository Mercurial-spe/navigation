<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Network</title>
    <script
      type="text/javascript"
      src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"
    ></script>
    <style type="text/css">
      #mynetwork {
        width: 1600px;
        height: 1200px;
        border: 1px solid lightgray;
      }
      #controls {
        padding: 10px;
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <div>
        <label for="startNode">选择起始节点:</label>
        <select id="startNode"></select>
        <label for="endNode">选择终点节点:</label>
        <select id="endNode"></select>
        <button id="findPath">查找路径</button>
        <button id="resetPath">重置路径</button>
      </div>
      <div>
        <h4>集群功能:</h4>
        <button id="clusterByConnection">按连接集群</button>
        <button id="clusterByHubsize">按中心度集群</button>
        <input type="number" id="hubsize" value="2" min="1" style="width:50px;" title="节点的最小边数" />
        <button id="clusterOutliers">集群离群点</button>
        <button id="resetClusters">重置集群</button>
      </div>
      <div id="pathInfo"></div>
    </div>
    <div id="mynetwork"></div>
    <script type="text/javascript">
      // create an array with nodes
      var nodes = new vis.DataSet([
        { id: 1, label: "Node 1", x: 100, y: 100, fixed: true },
        { id: 2, label: "Node 2", x: 300, y: 100, fixed: true },
        { id: 3, label: "Node 3", x: 500, y: 100, fixed: true },
        { id: 4, label: "Node 4", x: 100, y: 300, fixed: true },
        { id: 5, label: "Node 5", x: 300, y: 300, fixed: true },
        { id: 6, label: "Node 6", x: 500, y: 300, fixed: true },
        { id: 7, label: "Node 7", x: 100, y: 500, fixed: true },
        { id: 8, label: "Node 8", x: 300, y: 500, fixed: true },
        { id: 9, label: "Node 9", x: 500, y: 500, fixed: true },
        { id: 10, label: "Node 10", x: 700, y: 500, fixed: true },
      ]);

      // create an array with edges
      var edges = new vis.DataSet([
        { id: "1-3", from: 1, to: 3 },
        { id: "1-2", from: 1, to: 2 },
        { id: "2-4", from: 2, to: 4 },
        { id: "2-5", from: 2, to: 5 },
        { id: "3-6", from: 3, to: 6 },
        { id: "4-7", from: 4, to: 7 },
        { id: "5-8", from: 5, to: 8 },
        { id: "6-9", from: 6, to: 9 },
        { id: "7-8", from: 7, to: 8 },
        { id: "8-9", from: 8, to: 9 },
        { id: "9-10", from: 9, to: 10 },
      ]);

      // create a network
      var container = document.getElementById("mynetwork");
      var data = {
        nodes: nodes,
        edges: edges,
      };
      var options = {
        physics: {
          stabilization: false
        },
        nodes: {
          shape: 'dot',
          size: 20
        },
        manipulation: {
          enabled: false
        },
        interaction: {
          hover: true
        },
        // cluster设置
        clustering: {
          enabled: false,
          clusterNodeProperties: {
            borderWidth: 3,
            shape: 'box',
            font: { size: 16 },
            color: { 
              background: '#CCDDEE',
              border: '#2B7CE9'
            }
          }
        }
      };
      var network = new vis.Network(container, data, options);
      
      // 填充下拉菜单
      function populateDropdowns() {
        var startNodeSelect = document.getElementById("startNode");
        var endNodeSelect = document.getElementById("endNode");
        
        // 清空现有选项
        startNodeSelect.innerHTML = "";
        endNodeSelect.innerHTML = "";
        
        // 获取所有节点
        var nodeIds = nodes.getIds();
        
        // 为每个节点添加选项
        nodeIds.forEach(function(nodeId) {
          var node = nodes.get(nodeId);
          
          var startOption = document.createElement("option");
          startOption.value = nodeId;
          startOption.text = node.label;
          startNodeSelect.appendChild(startOption);
          
          var endOption = document.createElement("option");
          endOption.value = nodeId;
          endOption.text = node.label;
          endNodeSelect.appendChild(endOption);
        });
      }
      
      // 构建图的邻接表
      function buildAdjacencyList() {
        var adjacencyList = {};
        
        // 初始化邻接表
        nodes.getIds().forEach(function(nodeId) {
          adjacencyList[nodeId] = [];
        });
        
        // 填充邻接表
        edges.forEach(function(edge) {
          adjacencyList[edge.from].push(edge.to);
          // 假设图是无向的，如果是有向图则去掉下面这行
          adjacencyList[edge.to].push(edge.from);
        });
        
        return adjacencyList;
      }
      
      // 使用广度优先搜索查找路径
      function findShortestPath(startNodeId, endNodeId) {
        var adjacencyList = buildAdjacencyList();
        var visited = {};
        var queue = [];
        var previous = {};
        
        // 初始化
        nodes.getIds().forEach(function(nodeId) {
          visited[nodeId] = false;
          previous[nodeId] = null;
        });
        
        // 开始搜索
        visited[startNodeId] = true;
        queue.push(startNodeId);
        
        while (queue.length > 0) {
          var current = queue.shift();
          
          // 如果找到目标节点
          if (current == endNodeId) {
            // 重建路径
            var path = [];
            var currentNode = endNodeId;
            
            while (currentNode != null) {
              path.unshift(currentNode);
              currentNode = previous[currentNode];
            }
            
            return path;
          }
          
          // 探索所有邻居
          adjacencyList[current].forEach(function(neighbor) {
            if (!visited[neighbor]) {
              visited[neighbor] = true;
              previous[neighbor] = current;
              queue.push(neighbor);
            }
          });
        }
        
        // 如果没有路径
        return null;
      }
      
      // 高亮路径
      function highlightPath(path) {
        // 首先重置所有边
        resetHighlight();
        
        if (!path || path.length < 2) {
          document.getElementById("pathInfo").innerHTML = "找不到从起点到终点的路径";
          return;
        }
        
        // 高亮路径上的边
        for (var i = 0; i < path.length - 1; i++) {
          var fromId = path[i];
          var toId = path[i + 1];
          
          // 查找边ID
          var edgeId = findEdgeId(fromId, toId);
          if (edgeId) {
            edges.update({
              id: edgeId,
              color: { color: "red" },
              width: 3
            });
          }
        }
        
        document.getElementById("pathInfo").innerHTML = "路径找到: " + path.join(" -> ");
      }
      
      // 找到两个节点之间的边ID
      function findEdgeId(fromId, toId) {
        var edgesData = edges.get();
        for (var i = 0; i < edgesData.length; i++) {
          var edge = edgesData[i];
          if ((edge.from == fromId && edge.to == toId) || 
              (edge.from == toId && edge.to == fromId)) {
            return edge.id;
          }
        }
        return null;
      }
      
      // 重置高亮
      function resetHighlight() {
        var edgesData = edges.get();
        edgesData.forEach(function(edge) {
          edges.update({
            id: edge.id,
            color: { color: "#848484" },
            width: 1
          });
        });
        document.getElementById("pathInfo").innerHTML = "";
      }
      
      // 集群相关方法
      
      // 按连接性集群方法
      function clusterByConnection() {
        network.clustering.clusterByConnection(2, {
          clusterNodeProperties: {
            label: '集群-连接性',
            color: { background: '#ffccdd' }
          }
        });
        document.getElementById("pathInfo").innerHTML = "已按连接性完成集群";
      }
      
      // 按中心度集群方法
      function clusterByHubsize() {
        var hubsize = parseInt(document.getElementById("hubsize").value, 10);
        network.clustering.clusterByHubsize(hubsize, {
          clusterNodeProperties: {
            label: '集群-中心度',
            color: { background: '#ccffdd' }
          }
        });
        document.getElementById("pathInfo").innerHTML = "已按中心度完成集群，最小边数: " + hubsize;
      }
      
      // 集群离群点方法
      function clusterOutliers() {
        network.clustering.clusterOutliers({
          clusterNodeProperties: {
            label: '集群-离群点',
            color: { background: '#ddccff' }
          }
        });
        document.getElementById("pathInfo").innerHTML = "已完成离群点集群";
      }
      
      // 打开集群方法
      function openCluster(clusterId) {
        network.clustering.openCluster(clusterId);
      }
      
      // 重置所有集群
      function resetClusters() {
        network.clustering.clusterOutliers();
        var allNodeIds = nodes.getIds();
        for (var i = 0; i < allNodeIds.length; i++) {
          if (network.clustering.isCluster(allNodeIds[i])) {
            network.clustering.openCluster(allNodeIds[i]);
          }
        }
        document.getElementById("pathInfo").innerHTML = "已重置所有集群";
      }
      
      // 绑定事件
      document.getElementById("findPath").addEventListener("click", function() {
        var startNodeId = document.getElementById("startNode").value;
        var endNodeId = document.getElementById("endNode").value;
        
        var path = findShortestPath(startNodeId, endNodeId);
        highlightPath(path);
      });
      
      document.getElementById("resetPath").addEventListener("click", function() {
        resetHighlight();
      });
      
      // 绑定集群按钮事件
      document.getElementById("clusterByConnection").addEventListener("click", clusterByConnection);
      document.getElementById("clusterByHubsize").addEventListener("click", clusterByHubsize);
      document.getElementById("clusterOutliers").addEventListener("click", clusterOutliers);
      document.getElementById("resetClusters").addEventListener("click", resetClusters);
      
      // 双击打开集群
      network.on("doubleClick", function(params) {
        if (params.nodes.length === 1) {
          var nodeId = params.nodes[0];
          if (network.clustering.isCluster(nodeId)) {
            openCluster(nodeId);
            document.getElementById("pathInfo").innerHTML = "已打开集群: " + nodeId;
          }
        }
      });
      
      // 初始化下拉菜单
      populateDropdowns();
    </script>
  </body>
</html>
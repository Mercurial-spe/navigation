<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>导航系统地图渲染</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/2.4.0/sigma.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/graphology/0.25.4/graphology.umd.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map-container {
      width: 100%;
      height: 100vh;
      background-color: #f9f9f9;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div id="map-container">
    <div class="loading">加载地图数据中...</div>
  </div>

  <script>
    // 地图渲染函数
    function renderMap(detailData, overviewData) {
      console.time('总渲染时间');
      
      // 创建一个container容器
      const container = document.getElementById("map-container");
      
      // 创建graphology图实例
      const graph = new graphology.Graph();
      
      // 添加节点
      detailData.nodes.forEach(node => {
        graph.addNode(node.id, {
          label: node.label || `Node ${node.id}`,
          x: node.x,
          y: node.y,
          size: 5,
          color:  "#66ccff"
        });
      });
      
      // 添加边
      detailData.edges.forEach(edge => {
        if (edge.source === undefined || edge.target === undefined) {
          console.warn("跳过边，缺少source或target:", edge);
          return;
        }
        
        const source = edge.source;
        const target = edge.target;
        
        graph.addEdge(source, target, {
          size: 1,
          color: "#848484"
        });
      });
      
      // 创建Sigma实例
      const renderer = new Sigma(graph, container, {
        // 渲染设置
        renderEdgeLabels: false,
        minCameraRatio: 0.2,
        maxCameraRatio: 5,
        defaultNodeColor: "#66ccff",
        defaultEdgeColor: "#848484"
      });
      
      // 创建一个提示元素，提示当前的缩放比例
      const scaleInfo = document.createElement('div');
      scaleInfo.style.position = 'absolute';
      scaleInfo.style.bottom = '20px';
      scaleInfo.style.right = '20px';
      scaleInfo.style.padding = '10px';
      scaleInfo.style.backgroundColor = 'rgba(0,0,0,0.7)';
      scaleInfo.style.color = 'white';
      scaleInfo.style.borderRadius = '5px';
      scaleInfo.style.display = 'none';
      scaleInfo.style.zIndex = '1000';
      container.appendChild(scaleInfo);
      
      // 模式切换状态
      let currentMode = 'detail'; // 'detail' 或 'overview'
      let detailNodes = detailData.nodes;
      let detailEdges = detailData.edges;
      let overviewNodes = overviewData.nodes;
      let overviewEdges = overviewData.edges;
      
      // 定义切换到概览模式的函数
      function switchToOverviewMode() {
        console.time('切换到概览模式');
        
        // 清空图
        graph.clear();
        
        // 添加概览节点
        overviewNodes.forEach(node => {
          graph.addNode(node.id, {
            label: node.label || `Cluster ${node.id}`,
            x: node.x,
            y: node.y,
            size: 5,  // 使用权重作为大小
            color: "#66ccff"
          });
        });
        
              // 添加概览边
      overviewEdges.forEach(edge => {
        try {
          // 使用nullish合并运算符(??)而不是逻辑或(||)，以正确处理0值
          const source = edge.source !== undefined ? edge.source : edge.from;
          const target = edge.target !== undefined ? edge.target : edge.to;
          
          if (source === undefined || target === undefined) {
            console.warn("跳过边，缺少source或target:", edge);
            return;
          }
          
          graph.addEdge(source, target, {
            size: edge.size || 0.1,
            color: edge.color || "#848484"
          });
        } catch (e) {
          console.error("添加边时出错:", e, edge);
        }
      });
        
        currentMode = 'overview';
        renderer.refresh();
        console.timeEnd('切换到概览模式');
        console.log('已切换到概览模式，显示集群节点');
      }
      
      // 定义切换到详细模式的函数
      function switchToDetailMode() {
        console.time('切换到详细模式');
        
        // 清空图
        graph.clear();
        
        // 添加详细节点
        detailNodes.forEach(node => {
          graph.addNode(node.id, {
            label: node.label || `Node ${node.id}`,
            x: node.x,
            y: node.y,
            size:5,
            color:  "#66ccff"
          });
        });
        
              // 添加详细边
      detailEdges.forEach(edge => {
        try {
          // 使用nullish合并运算符(??)而不是逻辑或(||)，以正确处理0值
          const source = edge.source !== undefined ? edge.source : edge.from;
          const target = edge.target !== undefined ? edge.target : edge.to;
          
          if (source === undefined || target === undefined) {
            console.warn("跳过边，缺少source或target:", edge);
            return;
          }
          
          graph.addEdge(source, target, {
            size:  1,
            color: "#848484"
          });
        } catch (e) {
          console.error("添加边时出错:", e, edge);
        }
      });
        
        currentMode = 'detail';
        renderer.refresh();
        console.timeEnd('切换到详细模式');
        console.log('已切换到详细模式，显示所有节点');
      }
      
      // Test with a simpler event first
      renderer.on("clickNode", function(event) {
        console.log("clickNode event triggered:", event.node, event.event);
      });

      // 打印所有可用的事件名称
      console.log("renderer object:", renderer);
      
      // 监听相机状态变化事件 - 尝试各种可能的事件名称
      
      // 尝试监听"beforeRender"和"afterRender"生命周期事件
      // renderer.on("beforeRender", function() {
      //   console.log("beforeRender event triggered - camera ratio:", renderer.getCamera().ratio);
      // });
      
      // renderer.on("afterRender", function() {
      //   console.log("afterRender event triggered - camera ratio:", renderer.getCamera().ratio);
      // });
      
      // 尝试监听通用的鼠标滚轮事件，这常常用于缩放
      renderer.on("wheelStage", function(event) {
        console.log("wheelStage event triggered (likely zoom):", event);
        
        const camera = renderer.getCamera();
        const ratio = camera.ratio;
        console.log(`Camera ratio after wheel: ${ratio.toFixed(3)}, currentMode = ${currentMode}`);
        
        // 显示当前缩放比例
        scaleInfo.textContent = `Camera Ratio: ${ratio.toFixed(2)}`;
        scaleInfo.style.display = 'block';
        
        // 3秒后隐藏提示
        clearTimeout(scaleInfo.timeout);
        scaleInfo.timeout = setTimeout(() => {
          scaleInfo.style.display = 'none';
        }, 3000);
        
        // 根据缩放级别切换显示模式
        const ZOOM_OUT_THRESHOLD_RATIO = 1.6;

        if (ratio >= ZOOM_OUT_THRESHOLD_RATIO && currentMode === 'detail') {
          console.log(`Condition met: ratio (${ratio.toFixed(3)}) >= ${ZOOM_OUT_THRESHOLD_RATIO} AND currentMode is 'detail'. Switching to overview.`);
          switchToOverviewMode();
        } else if (ratio < ZOOM_OUT_THRESHOLD_RATIO && currentMode === 'overview') {
          console.log(`Condition met: ratio (${ratio.toFixed(3)}) < ${ZOOM_OUT_THRESHOLD_RATIO} AND currentMode is 'overview'. Switching to detail.`);
          switchToDetailMode();
        }
      });
      
      // 尝试监听拖动事件，这也会移动相机
      renderer.on("downStage", function() {
        console.log("downStage event triggered (drag start)");
      });
      
      renderer.on("clickStage", function() {
        console.log("clickStage event triggered");
        console.log("Current camera ratio:", renderer.getCamera().ratio);
      });

      // 移除加载提示
      const loadingElement = document.querySelector(".loading");
      if (loadingElement) {
        loadingElement.remove();
      }
      
      console.timeEnd('总渲染时间');
      console.log("地图渲染完成");
      console.log("Sigma renderer object:", renderer); // Log the renderer object
    }
    
    // 获取地图数据
    async function fetchMapData() {
      try {
        // 从后端获取详细视图数据
        const detailResponse = await fetch('/api/map-data/detail');
        if (!detailResponse.ok) {
          throw new Error(`HTTP error fetching detail data: ${detailResponse.status}`);
        }
        const detailData = await detailResponse.json();
        
        // 从后端获取概览视图数据
        const overviewResponse = await fetch('/api/map-data/overview');
        if (!overviewResponse.ok) {
          throw new Error(`HTTP error fetching overview data: ${overviewResponse.status}`);
        }
        const overviewData = await overviewResponse.json();
        
        // 将两套数据传递给渲染函数
        renderMap(detailData, overviewData);
      } catch (error) {
        console.error("获取地图数据失败:", error);
        document.querySelector(".loading").textContent = "加载地图数据失败，请刷新重试";
      }
    }

    // 页面加载后获取数据
    document.addEventListener('DOMContentLoaded', fetchMapData);
  </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>导航系统地图渲染</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/2.4.0/sigma.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/graphology/0.25.4/graphology.umd.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="map-container">
    <div class="loading">加载地图数据中...</div>
  </div>

  <script>
    // 地图渲染函数
    function renderMap(detailData, overviewData) {
      console.time('总渲染时间');
      
      // 创建一个container容器
      const container = document.getElementById("map-container");
      
      // 创建graphology图实例
      const graph = new graphology.Graph();
      
      // 添加节点
      detailData.nodes.forEach(node => {
        graph.addNode(node.id, {
          label: node.label || `Node ${node.id}`,
          x: node.x,
          y: node.y,
          size: 5,
          color:  "#66ccff"
        });
      });
      
      // 添加边
      detailData.edges.forEach(edge => {
        if (edge.source === undefined || edge.target === undefined) {
          console.warn("跳过边，缺少source或target:", edge);
          return;
        }
        
        const source = edge.source;
        const target = edge.target;
        
        graph.addEdge(source, target, {
          size: 1,
          color: "#848484"
        });
      });
      
      // 创建Sigma实例
      const renderer = new Sigma(graph, container, {
        // 渲染设置
        renderEdgeLabels: false,
        minCameraRatio: 0.2,
        maxCameraRatio: 5,
        defaultNodeColor: "#66ccff",
        defaultEdgeColor: "#848484"
      });
      
      // 创建一个提示元素，提示当前的缩放比例
      const scaleInfo = document.createElement('div');
      scaleInfo.className = 'scale-info';
      container.appendChild(scaleInfo);
      
      // 模式切换状态
      let currentMode = 'detail'; // 'detail' 或 'overview'
      let detailNodes = detailData.nodes;
      let detailEdges = detailData.edges;
      let overviewNodes = overviewData.nodes;
      let overviewEdges = overviewData.edges;
      
      // 定义切换到概览模式的函数
      function switchToOverviewMode() {
        console.time('切换到概览模式');
        
        // 清空图
        graph.clear();
        
        // 添加概览节点
        overviewNodes.forEach(node => {
          graph.addNode(node.id, {
            label: node.label || `Cluster ${node.id}`,
            x: node.x,
            y: node.y,
            size: 5,  // 使用权重作为大小
            color: "#66ccff"
          });
        });
        
              // 添加概览边
      overviewEdges.forEach(edge => {
        try {
          // 使用nullish合并运算符(??)而不是逻辑或(||)，以正确处理0值
          const source = edge.source !== undefined ? edge.source : edge.from;
          const target = edge.target !== undefined ? edge.target : edge.to;
          
          if (source === undefined || target === undefined) {
            console.warn("跳过边，缺少source或target:", edge);
            return;
          }
          
          graph.addEdge(source, target, {
            size: edge.size || 0.1,
            color: edge.color || "#848484"
          });
        } catch (e) {
          console.error("添加边时出错:", e, edge);
        }
      });
        
        currentMode = 'overview';
        renderer.refresh();
        console.timeEnd('切换到概览模式');
        console.log('已切换到概览模式，显示集群节点');
      }
      
      // 定义切换到详细模式的函数
      function switchToDetailMode() {
        console.time('切换到详细模式');
        
        // 清空图
        graph.clear();
        
        // 添加详细节点
        detailNodes.forEach(node => {
          graph.addNode(node.id, {
            label: node.label || `Node ${node.id}`,
            x: node.x,
            y: node.y,
            size:5,
            color:  "#66ccff"
          });
        });
        
              // 添加详细边
      detailEdges.forEach(edge => {
        try {
          // 使用nullish合并运算符(??)而不是逻辑或(||)，以正确处理0值
          const source = edge.source !== undefined ? edge.source : edge.from;
          const target = edge.target !== undefined ? edge.target : edge.to;
          
          if (source === undefined || target === undefined) {
            console.warn("跳过边，缺少source或target:", edge);
            return;
          }
          
          graph.addEdge(source, target, {
            size:  1,
            color: "#848484"
          });
        } catch (e) {
          console.error("添加边时出错:", e, edge);
        }
      });
        
        currentMode = 'detail';
        renderer.refresh();
        console.timeEnd('切换到详细模式');
        console.log('已切换到详细模式，显示所有节点');
      }
      
      // Test with a simpler event first
      renderer.on("clickNode", function(event) {
        console.log("clickNode event triggered:", event.node, event.event);
      });

      // 添加双击节点事件处理
      let lastClickTime = 0;
      const doubleClickDelay = 1000; // 毫秒
      let selectedNodeColor = "#FF5733"; // 选中节点颜色
      let nearbyNodeColor = "#33FF57"; // 附近节点颜色
      let originalNodeColor = "#66ccff"; // 原始节点颜色
      let nearbyEdgeColor = "#33FF57"; // 附近边颜色
      let originalEdgeColor = "#848484"; // 原始边颜色
      let nodeState = {}; // 保存节点原始状态
      let edgeState = {}; // 保存边原始状态
      
      // 单击节点事件，用于实现双击功能
      renderer.on("clickNode", function(event) {
        const nodeId = event.node;
        const currentTime = new Date().getTime();
        
        // 如果是双击（两次点击间隔小于doubleClickDelay）
        if (currentTime - lastClickTime < doubleClickDelay) {
          console.log("节点双击事件:", nodeId);
          
          // 获取节点的坐标信息
          const nodeAttributes = graph.getNodeAttributes(nodeId);
          const x = nodeAttributes.x;
          const y = nodeAttributes.y;
          
          // 发送请求到后端获取附近节点
          fetchNearbyNodes(x, y, 100);
        }
        
        lastClickTime = currentTime;
      });
      
      // 获取附近节点的函数
      function fetchNearbyNodes(x, y, count) {
        console.log(`获取坐标(${x}, ${y})附近的${count}个节点`);
        
        // 显示加载提示
        const loadingMsg = document.createElement('div');
        loadingMsg.textContent = '加载附近节点...';
        loadingMsg.className = 'info-message loading-message';
        loadingMsg.id = 'loading-nearby';
        container.appendChild(loadingMsg);
        
        // 发送请求到后端
        fetch(`/api/nearby_nodes?x=${x}&y=${y}&count=${count}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('网络响应错误');
            }
            return response.json();
          })
          .then(data => {
            console.log(`获取到${data.nodes.length}个附近节点和${data.edges.length}条边`);
            
            // 清除之前的高亮状态
            resetNodeAndEdgeColors();
            
            // 高亮双击的节点和附近节点及边
            highlightNearbyNodes(data.nodes, data.edges);
            
            // 移除加载提示
            const loadingEl = document.getElementById('loading-nearby');
            if (loadingEl) {
              loadingEl.remove();
            }
            
            // 显示结果提示
            const resultMsg = document.createElement('div');
            resultMsg.textContent = `显示附近${data.nodes.length}个节点和${data.edges.length}条边`;
            resultMsg.className = 'info-message result-message';
            resultMsg.id = 'result-nearby';
            container.appendChild(resultMsg);
            
            // 3秒后隐藏结果提示
            setTimeout(() => {
              const resultEl = document.getElementById('result-nearby');
              if (resultEl) {
                resultEl.remove();
              }
            }, 3000);
          })
          .catch(error => {
            console.error('获取附近节点失败:', error);
            
            // 移除加载提示
            const loadingEl = document.getElementById('loading-nearby');
            if (loadingEl) {
              loadingEl.remove();
            }
            
            // 显示错误提示
            const errorMsg = document.createElement('div');
            errorMsg.textContent = `获取附近节点失败: ${error.message}`;
            errorMsg.className = 'info-message error-message';
            errorMsg.id = 'error-nearby';
            container.appendChild(errorMsg);
            
            // 3秒后隐藏错误提示
            setTimeout(() => {
              const errorEl = document.getElementById('error-nearby');
              if (errorEl) {
                errorEl.remove();
              }
            }, 3000);
          });
      }
      
      // 高亮附近节点和边的函数
      function highlightNearbyNodes(nodes, edges) {
        // 保存所有节点的原始颜色
        graph.forEachNode((nodeId, attributes) => {
          if (!nodeState[nodeId]) {
            nodeState[nodeId] = {
              originalColor: attributes.color,
              originalSize: attributes.size
            };
          }
          
          // 默认所有节点都变暗淡
          graph.setNodeAttribute(nodeId, "color", "#cccccc");
          graph.setNodeAttribute(nodeId, "size", attributes.size * 0.8);
        });
        
        // 保存所有边的原始颜色
        graph.forEachEdge((edgeId, attributes) => {
          if (!edgeState[edgeId]) {
            edgeState[edgeId] = {
              originalColor: attributes.color,
              originalSize: attributes.size
            };
          }
          
          // 默认所有边都变暗淡
          graph.setEdgeAttribute(edgeId, "color", "#dddddd");
          graph.setEdgeAttribute(edgeId, "size", attributes.size * 0.5);
        });
        
        // 创建节点ID集合，用于快速查找
        const nodeIdSet = new Set(nodes.map(node => node.id.toString()));
        
        // 高亮附近节点
        nodes.forEach(node => {
          const nodeId = node.id;
          
          if (graph.hasNode(nodeId)) {
            // 对附近节点应用新颜色和大小
            graph.setNodeAttribute(nodeId, "color", nearbyNodeColor);
            graph.setNodeAttribute(nodeId, "size", 5);
            
            // 高亮第一个节点（双击的节点）为特殊颜色
            if (node.id === nodes[0].id) {
              graph.setNodeAttribute(nodeId, "color", selectedNodeColor);
              graph.setNodeAttribute(nodeId, "size", 8);
            }
          }
        });
        
        // 高亮附近边
        edges.forEach(edge => {
          const sourceId = edge.source;
          const targetId = edge.target;
          
          // 尝试查找边
          let graphEdge = null;
          try {
            graphEdge = graph.edge(sourceId, targetId);
          } catch (e) {
            try {
              // 有时边的方向可能反转
              graphEdge = graph.edge(targetId, sourceId);
            } catch (e2) {
              // 边不存在，忽略
              return;
            }
          }
          
          if (graphEdge) {
            // 对附近边应用新颜色和大小
            graph.setEdgeAttribute(graphEdge, "color", nearbyEdgeColor);
            graph.setEdgeAttribute(graphEdge, "size", 2);
          }
        });
        
        // 刷新渲染
        renderer.refresh();
      }
      
      // 重置节点和边颜色的函数
      function resetNodeAndEdgeColors() {
        // 重置节点颜色
        graph.forEachNode((nodeId, attributes) => {
          if (nodeState[nodeId]) {
            graph.setNodeAttribute(nodeId, "color", nodeState[nodeId].originalColor || originalNodeColor);
            graph.setNodeAttribute(nodeId, "size", nodeState[nodeId].originalSize || 5);
          } else {
            graph.setNodeAttribute(nodeId, "color", originalNodeColor);
            graph.setNodeAttribute(nodeId, "size", 5);
          }
        });
        
        // 重置边颜色
        graph.forEachEdge((edgeId, attributes) => {
          if (edgeState[edgeId]) {
            graph.setEdgeAttribute(edgeId, "color", edgeState[edgeId].originalColor || originalEdgeColor);
            graph.setEdgeAttribute(edgeId, "size", edgeState[edgeId].originalSize || 1);
          } else {
            graph.setEdgeAttribute(edgeId, "color", originalEdgeColor);
            graph.setEdgeAttribute(edgeId, "size", 1);
          }
        });
        
        renderer.refresh();
      }

      // 打印所有可用的事件名称
      console.log("renderer object:", renderer);
      
      // 监听相机状态变化事件 - 尝试各种可能的事件名称
      
      // 尝试监听"beforeRender"和"afterRender"生命周期事件
      // renderer.on("beforeRender", function() {
      //   console.log("beforeRender event triggered - camera ratio:", renderer.getCamera().ratio);
      // });
      
      // renderer.on("afterRender", function() {
      //   console.log("afterRender event triggered - camera ratio:", renderer.getCamera().ratio);
      // });
      
      // 尝试监听通用的鼠标滚轮事件，这常常用于缩放
      renderer.on("wheelStage", function(event) {
        console.log("wheelStage event triggered (likely zoom):", event);
        
        const camera = renderer.getCamera();
        const ratio = camera.ratio;
        console.log(`Camera ratio after wheel: ${ratio.toFixed(3)}, currentMode = ${currentMode}`);
        
        // 显示当前缩放比例
        scaleInfo.textContent = `Camera Ratio: ${ratio.toFixed(2)}`;
        scaleInfo.style.display = 'block';
        
        // 3秒后隐藏提示
        clearTimeout(scaleInfo.timeout);
        scaleInfo.timeout = setTimeout(() => {
          scaleInfo.style.display = 'none';
        }, 3000);
        
        // 根据缩放级别切换显示模式
        const ZOOM_OUT_THRESHOLD_RATIO = 1.6;

        if (ratio >= ZOOM_OUT_THRESHOLD_RATIO && currentMode === 'detail') {
          console.log(`Condition met: ratio (${ratio.toFixed(3)}) >= ${ZOOM_OUT_THRESHOLD_RATIO} AND currentMode is 'detail'. Switching to overview.`);
          switchToOverviewMode();
        } else if (ratio < ZOOM_OUT_THRESHOLD_RATIO && currentMode === 'overview') {
          console.log(`Condition met: ratio (${ratio.toFixed(3)}) < ${ZOOM_OUT_THRESHOLD_RATIO} AND currentMode is 'overview'. Switching to detail.`);
          switchToDetailMode();
        }
      });
      
      // 尝试监听拖动事件，这也会移动相机
      renderer.on("downStage", function() {
        console.log("downStage event triggered (drag start)");
      });
      
      renderer.on("clickStage", function() {
        console.log("clickStage event triggered");
        console.log("Current camera ratio:", renderer.getCamera().ratio);
      });

      // 移除加载提示
      const loadingElement = document.querySelector(".loading");
      if (loadingElement) {
        loadingElement.remove();
      }
      
      console.timeEnd('总渲染时间');
      console.log("地图渲染完成");
      console.log("Sigma renderer object:", renderer); // Log the renderer object
    }
    
    // 获取地图数据
    async function fetchMapData() {
      try {
        // 从后端获取详细视图数据
        const detailResponse = await fetch('/api/map-data/detail');
        if (!detailResponse.ok) {
          throw new Error(`HTTP error fetching detail data: ${detailResponse.status}`);
        }
        const detailData = await detailResponse.json();
        
        // 从后端获取概览视图数据
        const overviewResponse = await fetch('/api/map-data/overview');
        if (!overviewResponse.ok) {
          throw new Error(`HTTP error fetching overview data: ${overviewResponse.status}`);
        }
        const overviewData = await overviewResponse.json();
        
        // 将两套数据传递给渲染函数
        renderMap(detailData, overviewData);
      } catch (error) {
        console.error("获取地图数据失败:", error);
        document.querySelector(".loading").textContent = "加载地图数据失败，请刷新重试";
      }
    }

    // 页面加载后获取数据
    document.addEventListener('DOMContentLoaded', fetchMapData);
  </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Vis.js 集群功能演示</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style type="text/css">
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #container {
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .content {
            display: flex;
            height: 800px;
        }
        #mynetwork {
            flex: 3;
            height: 100%;
            border: 1px solid lightgray;
        }
        .panel {
            flex: 1;
            padding: 20px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            margin-right: 10px;
            overflow-y: auto;
        }
        .controls-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        button {
            padding: 8px 12px;
            margin: 5px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: block;
            width: 100%;
        }
        button:hover {
            background-color: #45a049;
        }
        .reset {
            background-color: #f44336;
        }
        .reset:hover {
            background-color: #d32f2f;
        }
        label {
            display: block;
            margin: 5px 0;
        }
        input, select {
            margin-bottom: 10px;
            padding: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        #nodeInfo {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Vis.js 集群功能演示</h1>
        <div class="content">
            <div class="panel">
                <div class="controls-group">
                    <h3>基本集群方法</h3>
                    <button id="clusterByConnection">按连接集群</button>
                    <select id="connectionNodeId">
                        <!-- 将由JavaScript填充 -->
                    </select>

                    <button id="clusterByHubsize">按中心度集群</button>
                    <label for="hubsize">最小边数:</label>
                    <input type="number" id="hubsize" value="2" min="1">

                    <button id="clusterOutliers">集群离群点</button>
                </div>

                <div class="controls-group">
                    <h3>自定义集群</h3>
                    <button id="clusterByColor">按颜色集群</button>
                    <label for="clusterColor">选择颜色:</label>
                    <select id="clusterColor">
                        <option value="red">红色</option>
                        <option value="green">绿色</option>
                        <option value="blue">蓝色</option>
                    </select>

                    <button id="clusterByProperty">按属性集群</button>
                    <label for="clusterProperty">属性名:</label>
                    <input type="text" id="clusterProperty" value="group">
                    <label for="propertyValue">属性值:</label>
                    <input type="text" id="propertyValue" value="1">
                </div>

                <div class="controls-group">
                    <h3>集群属性</h3>
                    <label for="clusterLabel">集群标签:</label>
                    <input type="text" id="clusterLabel" value="集群">
                    <label for="clusterBackgroundColor">背景颜色:</label>
                    <input type="color" id="clusterBackgroundColor" value="#CCDDEE">
                    <label for="clusterBorderColor">边框颜色:</label>
                    <input type="color" id="clusterBorderColor" value="#2B7CE9">
                    <label for="clusterShape">形状:</label>
                    <select id="clusterShape">
                        <option value="ellipse">椭圆</option>
                        <option value="circle">圆形</option>
                        <option value="box" selected>方形</option>
                        <option value="diamond">菱形</option>
                        <option value="star">星形</option>
                        <option value="triangle">三角形</option>
                    </select>
                </div>

                <div class="controls-group">
                    <h3>操作</h3>
                    <button id="resetClusters" class="reset">重置所有集群</button>
                    <div id="nodeInfo">
                        <p>双击集群节点打开集群</p>
                        <p>选中节点: <span id="selectedNode">无</span></p>
                    </div>
                </div>
            </div>
            <div id="mynetwork"></div>
        </div>
    </div>

    <script type="text/javascript">
        // 创建一个更复杂的节点数据集
        var nodes = new vis.DataSet();
        var edges = new vis.DataSet();

        // 添加节点
        for (let i = 1; i <= 50; i++) {
            let group = Math.floor((i - 1) / 10) + 1; // 将节点分为5组
            let color;
            
            switch(group) {
                case 1: color = "red"; break;
                case 2: color = "green"; break;
                case 3: color = "blue"; break;
                case 4: color = "orange"; break;
                case 5: color = "purple"; break;
            }
            
            nodes.add({
                id: i,
                label: "节点 " + i,
                group: group,
                color: {
                    background: color,
                    border: '#000000'
                }
            });
        }

        // 添加边 - 创建一些模式
        // 组内连接 - 确保同组的节点有连接
        for (let group = 1; group <= 5; group++) {
            let groupStart = (group - 1) * 10 + 1;
            let groupEnd = group * 10;
            
            for (let i = groupStart; i <= groupEnd; i++) {
                // 连接到同组的2-3个其他节点
                let connections = Math.floor(Math.random() * 2) + 2; // 2-3个连接
                
                for (let j = 0; j < connections; j++) {
                    let target;
                    do {
                        target = Math.floor(Math.random() * (groupEnd - groupStart + 1)) + groupStart;
                    } while (target === i); // 避免自连接
                    
                    edges.add({
                        from: i,
                        to: target
                    });
                }
            }
        }

        // 组间连接 - 添加一些跨组的连接
        for (let i = 0; i < 15; i++) { // 添加15个跨组连接
            let from = Math.floor(Math.random() * 50) + 1;
            let fromGroup = Math.floor((from - 1) / 10) + 1;
            
            let toGroup;
            do {
                toGroup = Math.floor(Math.random() * 5) + 1;
            } while (toGroup === fromGroup); // 确保是不同的组
            
            let toStart = (toGroup - 1) * 10 + 1;
            let to = Math.floor(Math.random() * 10) + toStart;
            
            edges.add({
                from: from,
                to: to
            });
        }

        // 添加几个离群点 (只有一个连接)
        for (let i = 0; i < 5; i++) {
            let outlier = 46 + i; // 使用节点ID 46-50作为离群点
            let connectedTo = Math.floor(Math.random() * 45) + 1; // 连接到节点1-45中的一个
            
            // 删除之前可能的多余连接
            let connectedEdges = edges.get({
                filter: function(edge) {
                    return edge.from === outlier || edge.to === outlier;
                }
            });
            
            edges.remove(connectedEdges);
            
            // 只添加一个连接
            edges.add({
                from: outlier,
                to: connectedTo
            });
        }

        // 创建网络
        var container = document.getElementById('mynetwork');
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {
            physics: {
                stabilization: true,
                barnesHut: {
                    gravitationalConstant: -2000,
                    centralGravity: 0.1,
                    springLength: 95,
                    springConstant: 0.04,
                    damping: 0.09
                }
            },
            nodes: {
                shape: 'dot',
                size: 16,
                font: {
                    size: 12,
                    face: 'Tahoma'
                },
                borderWidth: 2
            },
            edges: {
                width: 1,
                color: {
                    color: '#848484',
                    highlight: '#848484',
                    hover: '#848484'
                },
                smooth: {
                    type: 'continuous'
                }
            },
            interaction: {
                hover: true,
                navigationButtons: true,
                keyboard: true
            }
        };
        var network = new vis.Network(container, data, options);

        // 填充节点下拉列表
        function populateNodeDropdown() {
            var select = document.getElementById('connectionNodeId');
            select.innerHTML = '';
            
            var nodeIds = nodes.getIds();
            for (var i = 0; i < nodeIds.length; i++) {
                var option = document.createElement('option');
                option.value = nodeIds[i];
                option.text = '节点 ' + nodeIds[i];
                select.appendChild(option);
            }
        }
        populateNodeDropdown();

        // 获取集群属性对象
        function getClusterOptions() {
            return {
                joinCondition: null, // 将由各个函数定义
                processProperties: function(clusterOptions, childNodes, childEdges) {
                    // 计算总数并设置标签
                    clusterOptions.label = document.getElementById('clusterLabel').value + ' (' + childNodes.length + '个节点)';
                    return clusterOptions;
                },
                clusterNodeProperties: {
                    shape: document.getElementById('clusterShape').value,
                    color: {
                        background: document.getElementById('clusterBackgroundColor').value,
                        border: document.getElementById('clusterBorderColor').value
                    },
                    borderWidth: 3,
                    font: { size: 16 }
                }
            };
        }

        // 按连接进行集群
        document.getElementById('clusterByConnection').addEventListener('click', function() {
            var nodeId = document.getElementById('connectionNodeId').value;
            network.clustering.clusterByConnection(nodeId, getClusterOptions());
        });

        // 按中心度进行集群
        document.getElementById('clusterByHubsize').addEventListener('click', function() {
            var hubsize = parseInt(document.getElementById('hubsize').value);
            network.clustering.clusterByHubsize(hubsize, getClusterOptions());
        });

        // 集群离群点
        document.getElementById('clusterOutliers').addEventListener('click', function() {
            network.clustering.clusterOutliers(getClusterOptions());
        });

        // 按颜色进行集群
        document.getElementById('clusterByColor').addEventListener('click', function() {
            var color = document.getElementById('clusterColor').value;
            var options = getClusterOptions();
            
            options.joinCondition = function(nodeOptions) {
                return nodeOptions.color && 
                       nodeOptions.color.background && 
                       nodeOptions.color.background === color;
            };
            
            network.clustering.cluster(options);
        });

        // 按属性进行集群
        document.getElementById('clusterByProperty').addEventListener('click', function() {
            var property = document.getElementById('clusterProperty').value;
            var value = document.getElementById('propertyValue').value;
            var options = getClusterOptions();
            
            options.joinCondition = function(nodeOptions) {
                return nodeOptions[property] !== undefined && 
                       nodeOptions[property].toString() === value;
            };
            
            network.clustering.cluster(options);
        });

        // 重置所有集群
        document.getElementById('resetClusters').addEventListener('click', function() {
            network.clustering.clusterOutliers();
            var clusterNodeIds = [];
            var allNodeIds = nodes.getIds();
            
            // 找出所有集群节点
            for (var i = 0; i < allNodeIds.length; i++) {
                if (network.clustering.isCluster(allNodeIds[i])) {
                    clusterNodeIds.push(allNodeIds[i]);
                }
            }
            
            // 打开所有集群
            for (var i = 0; i < clusterNodeIds.length; i++) {
                network.clustering.openCluster(clusterNodeIds[i]);
            }
            
            document.getElementById('selectedNode').textContent = '无';
        });

        // 双击打开集群
        network.on('doubleClick', function(params) {
            if (params.nodes.length === 1) {
                var nodeId = params.nodes[0];
                if (network.clustering.isCluster(nodeId)) {
                    network.clustering.openCluster(nodeId);
                }
            }
        });

        // 更新选中节点信息
        network.on('click', function(params) {
            if (params.nodes.length === 1) {
                var nodeId = params.nodes[0];
                var isCluster = network.clustering.isCluster(nodeId);
                var nodeText = '节点 ' + nodeId + (isCluster ? ' (集群)' : '');
                document.getElementById('selectedNode').textContent = nodeText;
            } else {
                document.getElementById('selectedNode').textContent = '无';
            }
        });
    </script>
</body>
</html>
